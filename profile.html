<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="assets/images/profile.png">


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/navigation.js"></script>

  <!-- icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: "Nunito", sans-serif;
    }

    h3 {
      text-align: center;
    }

    .button-27 {
      appearance: none;
      background-color: #000000;
      border: 2px solid #1A1A1A;
      border-radius: 15px;
      color: #FFFFFF;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      padding: 8px 18px;
      transition: all 300ms;
      text-align: center;
      height: 100%;
    }

    .button-27:hover {
      box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
      background-color: #a70817;
      border: 2px solid #a70817;
    }

    .container-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 2em;
    }

    div#profile-container img {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
    }

    div#profile-container {
      text-align: center;
    }

    #user-posts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      width: 100%;
      margin: 0 auto;
      text-align: center;
    }

    .post {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 6px;
      background-color: #fff;
    }

    .post img {
      width: 100%;
      border-radius: 8px;
      height: 300px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 50%;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .pro-btn {
      text-align: center;
      width: 100%;
    }

    .post-container-turst {
      padding: 24px;
    }

    .post-container-turst h2 {
    font-size: 42px;
    margin-left: 10px;
}
    form input,
    form textarea,
    form button {
      display: block;
      width: 96%;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 3px;
      border: 1px solid black;
    }

    form input,
    form textarea:hover {

      border: 1px solid rgb(214, 11, 11);
    }

    div#edit-modal::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body>
  <div id="navbar"></div>
  <div class="container-wrap">
    <div id="profile-container"></div>
    <div class="pro-btn">
      <button class="button-27" onclick="handleSignout()">Sign Out</button>
      <button class="button-27" id="edit-profile-button">Edit profile</button>
    </div>
  </div>

  <div id="edit-profile-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-modal">&times;</span>
      <h2>Edit Profile</h2>
      <form id="update-profile-form">
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Enter new username"><br><br>

        <label for="profile-image-url">Profile Image URL:</label>
        <input type="url" id="profile-image-url" placeholder="Enter image URL"><br><br>

        <button class="button-27" type="submit">Save</button>
      </form>
    </div>
  </div>

  <div class="post-container-turst">
    <h2 class="underline-small">Your Posts</h2>
    <div id="user-posts"></div>
  </div>

  <footer>
    <p>&copy; 2025 Blogify. All rights reserved.</p>
  </footer>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const profileContainer = document.getElementById("profile-container");
      const userPostsContainer = document.getElementById("user-posts");
      const editProfileButton = document.getElementById("edit-profile-button");
      const editProfileModal = document.getElementById("edit-profile-modal");
      const closeModal = document.getElementById("close-modal");
      const updateForm = document.getElementById("update-profile-form");

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const defaultImage =
            "https://static.vecteezy.com/system/resources/thumbnails/020/765/399/small/default-profile-account-unknown-icon-black-silhouette-free-vector.jpg";
          const displayName = user.displayName || "Anonymous";
          const photoURL = user.photoURL || defaultImage;

          // Display user info
          profileContainer.innerHTML = `
            <img src="${photoURL}" alt="Profile Image">
            <h3>${displayName}</h3>
            <p>${user.email}</p>
          `;

          // Load user posts
          try {
            const querySnapshot = await db
              .collection("posts")
              .where("userId", "==", user.uid)
              .orderBy("createdAt", "desc")
              .get();

            if (!querySnapshot.empty) {
              querySnapshot.forEach((doc) => {
                const post = doc.data();
                const postId = doc.id;

                const postElement = `
                  <div class="post" data-id="${postId}">
                    <p><small>Created on: ${post.createdAt?.toDate().toLocaleString() || "Unknown"
                  }</small></p>
                      <h3>${post.title}</h3>
                    ${post.imageUrl
                    ? `<img src="${post.imageUrl}" alt="Post Image" style="max-width: 100%;">`
                    : ""
                  }
                    
                     <p>${post.content}</p>
                    <button class="edit-post-button" data-id="${postId}"><i class="fa-regular fa-pen-to-square"></i></button>
                    <button class="delete-post-button" data-id="${postId}"><i class="fa-solid fa-trash"></i></button>
                  </div>
                `;
                userPostsContainer.innerHTML += postElement;
              });
            } else {
              userPostsContainer.innerHTML = "<p>No posts found.</p>";
            }
          } catch (error) {
            console.error("Error fetching posts:", error.message, error);
            userPostsContainer.innerHTML = "<p>Failed to load posts. Check console for details.</p>";
          }

          // Show modal when "Edit Profile" is clicked
          editProfileButton.addEventListener("click", () => {
            document.getElementById("username").value = displayName;
            document.getElementById("profile-image-url").value = photoURL;
            editProfileModal.style.display = "block";
          });

          // Close modal when clicking the "x" or outside the modal
          closeModal.addEventListener("click", () => {
            editProfileModal.style.display = "none";
          });

          window.addEventListener("click", (event) => {
            if (event.target === editProfileModal) {
              editProfileModal.style.display = "none";
            }
          });

          // Handle profile update
          updateForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const newUsername = document.getElementById("username").value.trim();
            const newPhotoURL = document.getElementById("profile-image-url").value.trim();

            try {
              await user.updateProfile({
                displayName: newUsername,
                photoURL: newPhotoURL,
              });

              alert("Profile updated successfully!");
              location.reload(); // Reload the page to reflect changes
            } catch (error) {
              console.error("Error updating profile:", error);
              alert("Failed to update profile. Please try again.");
            }
          });

          // Handle delete post
          userPostsContainer.addEventListener("click", async (event) => {
            if (event.target.classList.contains("delete-post-button")) {
              const postId = event.target.getAttribute("data-id");

              if (confirm("Are you sure you want to delete this post?")) {
                try {
                  await db.collection("posts").doc(postId).delete();
                  alert("Post deleted successfully!");
                  location.reload(); // Refresh the page to reflect changes
                } catch (error) {
                  console.error("Error deleting post:", error);
                  alert("Failed to delete post. Please try again.");
                }
              }
            }
          });

          // Handle edit post
          userPostsContainer.addEventListener("click", (event) => {
            if (event.target.classList.contains("edit-post-button")) {
              const postId = event.target.getAttribute("data-id");
              const postElement = document.querySelector(`div[data-id="${postId}"]`);
              const title = postElement.querySelector("h3").innerText;
              const content = postElement.querySelector("p").innerText;

              const editModalHTML = `
                <div id="edit-modal" class="modal" style="display: block;">
                  <div class="modal-content">
                    <h2>Edit Post</h2>
                    <form id="edit-post-form">
                      <label for="edit-title">Title:</label>
                      <input type="text" id="edit-title" value="${title}" required><br><br>
                      <label for="edit-content">Content:</label>
                      <textarea id="edit-content" required>${content}</textarea><br><br>
                      <button type="submit">Save Changes</button>
                      <button type="button" id="cancel-edit">Cancel</button>
                    </form>
                  </div>
                </div>
              `;
              document.body.insertAdjacentHTML("beforeend", editModalHTML);

              const editForm = document.getElementById("edit-post-form");
              const cancelEditButton = document.getElementById("cancel-edit");
              const modal = document.getElementById("edit-modal");

              // Save changes
              editForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const newTitle = document.getElementById("edit-title").value.trim();
                const newContent = document.getElementById("edit-content").value.trim();

                try {
                  await db.collection("posts").doc(postId).update({
                    title: newTitle,
                    content: newContent,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  });

                  alert("Post updated successfully!");
                  modal.remove();
                  location.reload(); // Refresh the page to reflect changes
                } catch (error) {
                  console.error("Error updating post:", error);
                  alert("Failed to update post. Please try again.");
                }
              });

              // Cancel edit
              cancelEditButton.addEventListener("click", () => {
                modal.remove();
              });

              // Close modal on outside click
              window.addEventListener("click", (e) => {
                if (e.target === modal) {
                  modal.remove();
                }
              });
            }
          });
        } else {
          window.location.href = "signin.html"; // Redirect if not logged in
        }
      });
    });
  </script>

</body>

</html>